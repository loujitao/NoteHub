&emsp;<a href="#0">Zook</a>  
&emsp;&emsp;<a href="#1">Zookeeper是什么</a>  
&emsp;&emsp;<a href="#2">Zookeeper有什么特性</a>  
&emsp;&emsp;<a href="#3">Zookeper的作用、优缺点、应用场景</a>  
&emsp;&emsp;<a href="#4">Zookeeper的选举策略</a>  
## <a name="0">Zook


### <a name="1">Zookeeper是什么


Zookeeper是一个开源的分布式的，为分布式应用提供协调服务的Apache项目

Zookeeper从设计模式角度来理解，是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生了变化，Zookeeper就负责通知已经在Zookeeper上注册的那些观察者做出相应的反应。

Zookeeper提供的服务包括：统一命名服务、统一配置管理、统一集群管理、服务器节点动态上下线、软负载均衡等。它致力于为那些高吞吐的大型分布式系统提供一个高性能、高可用且具有严格顺序访问控制能力的分布式协调服务。

### <a name="2">Zookeeper有什么特性


- 顺序一致性：从一个客户端发起的事务请求，最终都会严格按照其发起顺序被应用到Zookeeper中，对于来自客户端的每个更新请求，Zookeeper都会分配一个全局唯一的递增ID(zxid)，这个ID反映了所有事务请求的先后顺序。
- 原子性：所有事务请求的处理结果在整个集群中所有机器上都是一致的
- 最终一致性：所有客户端到的服务端数据模型都是一致的
- 可靠性：一旦服务端成功应用了一个事务，则会引起的改变为一直保留，直到被另外一个事务所更改，如果消息被一台服务器接收，那么它将被所有的服务器接受
- 实时性：一旦一个事务被成功应用后，Zookeeper可以保证客户端立即可以读取到这个事务变更后的最新状态数据
- 等待无关：慢的或者失效的client不得干预快速的client的请求，使得每个client都能有效地等待

Zookeeper的所有更新和删除都是基于事务的，所以其在读多写少的应用场景中有着很高的性能表现

Zookeeper将数据存全量储在内存以备高性能，并通过服务集群来实现高可用。

### <a name="3">Zookeper的作用、优缺点、应用场景


作用：存储数据（文件系统）和监听（监听通知机制）

优点

```
1）分布式协调过程简单
2）同步：zk高度同步，这意味着服务器进程之间既存在互斥又存在合作，有助于Apache HBase进行配置管理
3）有序消息：zk跟踪一个数字，表示每个更新的顺序，保证消息有序
4）序列化：根据具体规则，zk对数据进行编码。另外，它还可确保我们的应用程序始终如一地运行。但是，在MapReduce中，我们使用此方法（序列化）来协调队列以执行正在运行的线程
5）速度：在读请求多的情况下，能以很快的速度运行
6）可扩展性：可以通过部署更多机器来加强zk的性能
```

缺点

```
1）增加新的zk服务器时可能会导致数据丢失
2）不能迁移
	在没有用户干预的情况下，zk服务器无法从版本3.4迁移到3.3，然后迁移回3.4
3）节点数要求为奇数个
4）机架感知复制
	目前，不支持机架放置和感知
5）缩容
	不支持减少pod的数量，以防止意外数据丢失
6）磁盘变更
	不支持在初始部署后更改volume要求，以防止重新分配意外丢失数据
7）虚拟网络
	当服务部署在虚拟网络上时，如果没有完全重新安装，服务可能无法切换到主机网络。另外，对于尝试从主机切换到虚拟网络，它们是相同的情况
8）Kerberos
	在虚拟网络上，目前不支持启用Kerberos
9）支持有限
	对跨集群方案的支持非常有限。但是，没有CP系统会一直支持跨集群。
```

应用场景

```
1）数据的发布/订阅
Zookeeper通过Watch机制可以实现数据的发布和订阅，分布式系统的所有的服务节点可以对某个ZNode注册监听，之后只需要将新的配置写入该ZNode，所有服务节点都会收到该事件。
2）命名服务
Zookeeper可以通过顺序节点的特性来生成全局唯一ID，从而可以对分布式系统提供命名服务
3）Master选举
分布式系统一直重要的模式就是主从模式（Master/Salves），Zookeeper可以让所有服务节点去竞争性地创建同一个ZNode，由于Zookeeper不能有路径相同的ZNode，必然只有一个服务节点能够创建成功，这样该服务节点就可以成为Master节点。
4）分布式锁
通过Zookeeper的临时节点和Watcher机制来实现分布锁。
5）集群管理
可以通过创建临时节点来建立心跳检测机制；通过数据订阅和发布功能，Zookeeper还能对分布式系统进行模块的解耦和任务的调度；通过监听机制，对分布式系统的服务节点进行动态上下线，从而实现服务的动态扩容。
6）事务操作
在Zookeeper中，能够改变Zookeeper服务器状态的操作称为事务操作。一般包括数据节点创建与删除、数据内容更新和客户端会话创建与失效等操作。对应每一个事务请求，Zookeeper都会为其分配一个全局唯一的事务ID，用ZXID表示，通常是一个64位的数字。每一个ZXID对应一次更新操作，从这些ZXID中可以间接地识别出Zookeeper处理这些事务操作请求的全局顺序
```

### <a name="4">Zookeeper的选举策略


半数机制：集群中半数以上机器存活，集群可用。所以Zookeeper安装奇数台服务器

假设有五台服务器组成的Zookeeper集群，它们的id从1-5，同时它们都是最新启动的，也就是没有历史数据，再存放数据量这一点上，都是一样的。架设这些服务器依序启动，会发生什么？？

![image-20220315113739762](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20220315113739762.png)

```
1）服务器1启动，发起一次选举，服务器1投自己一票。此时服务器1票数一票，不够半数以上（3），选举无法完成，服务器1状态保持为LOOKING
2）服务器2启动，再发起一次选举。分别投自己一票并交换选票信息；此时服务器1发现服务器2的ID比自己目前投票推举的（服务器1）大，更改选票为服务器2。此时服务器1为零票，服务器2为两票，没有半数以上结果，选举无法完成，服务器1,2状态保持LOOKING
3）服务器3启动，再发起一次选举。分别投自己一票.....服务器3的票数为三， 超过半数，当选Leader。服务器1,2更改状态为FOLLOWING，服务器3更改状态为LEADING
4）服务器4启动，发起一次选举。此时服务器1,2,3已经不是LOOKING状态，不会更改选票信息。交换选票信息结果：服务器3为三票，服务器4为一票。此时服务器4服从多数，更改选票信息为服务器3,并更改状态为FOLLOWING
5）服务器5启动，同4一样当小弟
```

Leader：是zookeeper集群的中心，负责协调集群中的其他节点

```
1）发起与提写请求
	所有的跟随者Follow与观察者Observer节点的写请求都会转交给领导者Leader执行。Leader接受到一个写请求后，首先会发送给所有的Follower，统计Follwer写入成功的数量。当有超过半数的Follower写入成功后，Leader就会认为这个写请求提交成功，通知所有的Follower commit这个写操作，保证事后哪怕是集群崩溃恢复或重启，这个写操作也不会丢失
2）与Learner(Follower与Observer)保持心跳
3）崩溃时负责恢复数据以及同步数据到Learner
```

跟随者Follower：Follow在集群中有多个

```
1）与老大Leader保持心跳连接
2）当Leader挂了的时候，经过投票后成为新的leader。leader的重新选举是由剩下的Follower内部投票选择
3）向leader发送消息与请求
4）处理leader发来的消息与请求
```

